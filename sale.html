// =============================================================
// Kinaya Rising POS - Clean Simplified Version (Split Payment)
// =============================================================

// ---------- Constants ----------
const TAX_RATE = 0.07;
const ENDPOINT = "https://script.google.com/macros/s/14LQqEsRumpXVeC7ZKEd8CX2FHZoztKHsuROG6DQg4uR_iZOBgcX9esxj/exec";

// ---------- Global State ----------
let order = [];
let cashPaid = 0;
let cardPaid = 0;
let isReturnMode = false;

// ---------- Utility ----------
const fmt = (num) => `$${(num || 0).toFixed(2)}`;

// ---------- Load Menu ----------
document.addEventListener("DOMContentLoaded", () => {
  const menu = document.getElementById("menu");
  const products = [
    { sku: "B0F8NFSWXW", name: "Book - AoL Part 1", price: 14.98 },
    { sku: "BKM-001", name: "Bookmarks", price: 2.0 },
  ];

  products.forEach((p) => {
    const item = document.createElement("div");
    item.className = "menu-item";
    item.innerHTML = `
      <figcaption>${p.name}</figcaption>
      <figcaption>${p.sku}</figcaption>
      <figcaption>${fmt(p.price)}</figcaption>`;
    item.onclick = () => addItem(p);
    menu.appendChild(item);
  });

  document.getElementById("cash-btn").onclick = () => openPaypad("cash");
  document.getElementById("card-btn").onclick = () => openPaypad("card");
  document.getElementById("clear-order-btn").onclick = clearOrder;
  document.getElementById("toggle-return").onclick = toggleReturn;
  document.getElementById("submit-sale").onclick = submitSale;

  setupPaypad();
  updateUI();
});

// ---------- Add / Remove ----------
function addItem(product) {
  const existing = order.find((i) => i.sku === product.sku);
  if (existing) existing.qty += 1;
  else order.push({ ...product, qty: 1 });
  updateUI();
}

function removeItem(sku) {
  order = order.filter((i) => i.sku !== sku);
  updateUI();
}

// ---------- Totals ----------
function calcTotals() {
  const subtotal = order.reduce((s, i) => s + i.qty * i.price, 0);
  const tax = subtotal * TAX_RATE;
  const total = subtotal + tax;
  return { subtotal, tax, total };
}

// ---------- Update UI ----------
function updateUI() {
  const tbody = document.getElementById("receipt-details");
  tbody.innerHTML = "";

  order.forEach((item) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.qty}</td>
      <td>${fmt(item.price)}</td>
      <td>${fmt(item.qty * item.price)}</td>
      <td><button class="delete" onclick="removeItem('${item.sku}')"><i class='fa-solid fa-xmark'></i></button></td>`;
    tbody.appendChild(tr);
  });

  const { subtotal, tax, total } = calcTotals();
  document.getElementById("subtotal-summary").textContent = fmt(subtotal);
  document.getElementById("tax-summary").textContent = fmt(tax);
  document.getElementById("grandtotal-summary").textContent = fmt(total);

  const splitText = [];
  if (cashPaid) splitText.push(fmt(cashPaid) + " Cash");
  if (cardPaid) splitText.push(fmt(cardPaid) + " Card");
  document.getElementById("split-info").textContent = splitText.join(" ");
  document.getElementById("amount-paid-input").value = fmt(cashPaid + cardPaid);
  document.getElementById("submit-sale").style.display =
    order.length > 0 && (cashPaid + cardPaid) >= total ? "block" : "none";
}

// ---------- Clear / Return ----------
function clearOrder() {
  if (!confirm("Clear current order?")) return;
  order = [];
  cashPaid = cardPaid = 0;
  updateUI();
}

function toggleReturn() {
  isReturnMode = !isReturnMode;
  document.getElementById("toggle-return").classList.toggle("active", isReturnMode);
}

// ---------- Paypad ----------
let activeMethod = null;
let currentInput = "";

function setupPaypad() {
  const overlay = document.getElementById("payment-overlay");
  document.getElementById("close-paypad-btn").onclick = () => closePaypad();
  overlay.querySelectorAll(".paypad-btn").forEach((btn) =>
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      if (!id) return;
      if (id === "clear") currentInput = "";
      else if (id === "back") currentInput = currentInput.slice(0, -1);
      else if (id === "enter") finalizePaypad();
      else currentInput += id;
      updateDisplay();
    })
  );
}

function openPaypad(method) {
  activeMethod = method;
  currentInput = "";
  updateDisplay();
  document.getElementById("payment-overlay").style.display = "flex";
}

function closePaypad() {
  document.getElementById("payment-overlay").style.display = "none";
}

function updateDisplay() {
  const num = parseFloat(currentInput) / 100 || 0;
  document.getElementById("paypad-display").textContent = fmt(num);
}

function finalizePaypad() {
  const amount = parseFloat(currentInput) / 100 || 0;
  if (amount <= 0) return;
  if (activeMethod === "cash") cashPaid += amount;
  else cardPaid += amount;
  closePaypad();
  updateUI();
}

// ---------- Submit ----------
async function submitSale() {
  const email = document.getElementById("customer-email").value.trim();
  const { subtotal, tax, total } = calcTotals();
  const date = new Date().toLocaleDateString("en-US");

  const rows = order.map((i) => ({
    Date: date,
    Sku: i.sku,
    ProductTitle: i.name,
    Quantity: i.qty,
    Price: i.price,
    Subtotal: i.qty * i.price,
    Tax: tax,
    Total: total,
    Email: email,
    Payment: [
      cashPaid ? fmt(cashPaid) + " Cash" : "",
      cardPaid ? fmt(cardPaid) + " Card" : "",
    ]
      .filter(Boolean)
      .join(" "),
  }));

  try {
    const res = await fetch(ENDPOINT, {
      method: "POST",
      body: JSON.stringify(rows),
      headers: { "Content-Type": "application/json" },
    });
    const text = await res.text();
    alert(text.includes("Success") ? "✅ Sale recorded!" : "❌ Error saving sale");
  } catch (err) {
    alert("Error submitting sale: " + err);
  }

  clearOrder();
}
